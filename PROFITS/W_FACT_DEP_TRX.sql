CREATE VIEW W_FACT_DEP_TRX  AS  SELECT dep_trx_recording.trx_date           ,dep_trx_recording.trx_unit trx_unit           ,dep_trx_recording.trx_usr trx_user           ,trx_usr_sn trx_sn           ,tun_internal_sn tun_internal_sn           ,dep_trx_recording.tmstamp           ,dep_trx_recording.channel_id           ,dep_trx_recording.id_product product_code           ,pr.description product_description           ,trx_code           ,i_id_justific justification_code           ,   dep_trx_recording.i_comments            || NVL2 (LENGTH (TRIM (atm_reference_number))                    ,' | ' || atm_reference_number                    ,'')               comments           ,dep_trx_recording.acc_id_currency currency_id           ,currency.short_descr currency           ,CASE               WHEN dep_trx_recording.trn_type IN ('7', '8') THEN 'Reversal'               ELSE 'Original'                END               reversal_flag           ,DECODE (dep_trx_recording.trn_type                   ,'0', 'Non-financial'                   ,'1', 'Cash Debit'                   ,'2', 'Cash Credit'                   ,'3', 'Journal Debit'                   ,'4', 'Journal Credit'                   ,'5', 'Memo Debit'                   ,'6', 'Memo Credit'                   ,'7', 'Reversal of Cash Debit'                   ,'8', 'Reversal of Cash Credit'                   ,'A', 'Journal Credit Debit'                   ,'B', 'Journal Debit Credit'                   ,'F', 'Forecast'                   ,'n/a')               trn_type_ind           ,DECODE (dep_trx_recording.trn_type                   ,' ', 'Non-financial'                   ,'0', 'Non-financial'                   ,NULL, 'Non-financial'                   ,'Financial')               financial_flag           ,  CASE                 WHEN dep_trx_recording.trn_type IN ('1', '7') THEN 1                 ELSE 0                  END            * dep_trx_recording.u_user_totals_amn               cash_debit_amt           ,  CASE                 WHEN dep_trx_recording.trn_type IN ('2', '8') THEN 1                 ELSE 0                  END            * dep_trx_recording.u_user_totals_amn               cash_credit_amt           ,  CASE                 WHEN dep_trx_recording.trn_type IN ('3', 'A', 'B') THEN 1                 ELSE 0                  END            * dep_trx_recording.u_user_totals_amn               journal_debit_amt           ,  CASE                 WHEN dep_trx_recording.trn_type IN ('4', 'A', 'B') THEN 1                 ELSE 0                  END            * dep_trx_recording.u_user_totals_amn               journal_credit_amt           ,DECODE (transaction_status, '1', 'Reversed', 'Posted')               transaction_status_flag           ,DECODE (               NVL (i_trx_unit, 0)              ,0, ' '              ,   TO_CHAR (i_trx_date, 'yyyy-mm-dd')               || '|'               || i_trx_unit               || '|'               || TRIM (i_trx_usr)               || '|'               || i_trx_usr_sn               || '|'               || i_tun_internal_sn)               reversed_tun           ,p.account_ser_num acct_key           ,DECODE (LENGTH (TRIM (account_number))                   ,NULL, ' '                   ,TRIM (account_number) || '-' || account_cd)               account_no           ,dep_trx_recording.o_value_date value_date           ,dep_trx_recording.i_account_number dep_acc_number           ,dep_trx_recording.o_cheque_num cheque_num           ,justific.description justification_name           ,prft_transaction.description transaction_name           ,dep_trx_recording.acc_amount_40 commission_amt           ,dep_trx_recording.acc_amount_41 expense_amt           ,dep_trx_recording.acc_amount_42 tax_amt           ,dep_trx_recording.authorizer1           ,dep_trx_recording.authorizer2           ,CASE               WHEN    NVL (dep_trx_recording.o_fixing_rate, 0) = 0                    OR currency.national_flag = '1'               THEN                  1               ELSE                  dep_trx_recording.o_fixing_rate                END               "FIXING_RATE"           ,cust_id1 customer_code           ,u_user_totals_amn amount         FROM   dep_trx_recording            LEFT JOIN profits_account p               ON     i_account_number = p.dep_acc_number                  AND p.prft_system = 3                  AND p.dep_acc_number > 0            LEFT JOIN currency               ON currency.id_currency = dep_trx_recording.acc_id_currency            LEFT JOIN justific               ON justific.id_justific = dep_trx_recording.i_id_justific            LEFT JOIN prft_transaction               ON prft_transaction.id_transact = dep_trx_recording.trx_code            LEFT JOIN product pr               ON pr.id_product = dep_trx_recording.id_product            LEFT JOIN (    SELECT tun_date                             ,tun_unit                             ,tun_user_sn                             ,tun_usr                             ,MAX (reference_number) atm_reference_number                           FROM   atm_trx_recording                       GROUP BY tun_date                               ,tun_unit                               ,tun_user_sn                               ,tun_usr) atm               ON     atm.tun_date = dep_trx_recording.trx_date                  AND atm.tun_unit = dep_trx_recording.trx_unit                  AND atm.tun_usr = dep_trx_recording.trx_usr                  AND atm.tun_user_sn = dep_trx_recording.trx_usr_sn  WITH NO ROW MOVEMENT;

