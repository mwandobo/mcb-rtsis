CREATE VIEW w_stg_loan_ratevaldate  AS     WITH t          AS (SELECT fk_unitcode                    ,acc_type                    ,acc_sn                    ,bank_parameters.curr_trx_date curdate                    ,loans0.prv_fx_int_scal_dt prvscale                    ,loans0.prv_fx_int_exp_dt prvexpire                    ,loans0.cur_fx_int_scal_dt curscale                    ,loans0.cur_fx_int_exp_dt curexpire                    ,loans0.fkint_as_floating floating                    ,loans0.fkcur_is_moved_in curr              FROM   loan_account loans0 JOIN bank_parameters ON (1 = 1))     SELECT pa.account_number           ,CASE               WHEN prvexpire >= curdate THEN prvscale               WHEN curexpire >= curdate THEN curscale               ELSE MAX (validity_date)            END               rate_val_date     FROM   t            JOIN profits_account pa               ON     t.fk_unitcode = pa.lns_open_unit                  AND t.acc_type = pa.lns_type                  AND t.acc_sn = pa.lns_sn                  AND pa.prft_system = 4            LEFT JOIN int_scale               ON fk_interestid_inte = floating AND fk_currencyid_curr = curr     GROUP BY pa.account_number             ,prvexpire             ,curdate             ,prvscale             ,curexpire             ,curscale;

