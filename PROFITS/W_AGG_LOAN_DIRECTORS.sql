CREATE VIEW W_AGG_LOAN_DIRECTORS  AS  WITH cust         AS (    SELECT cust_id                   ,TRIM (surname) || ' ' || TRIM (first_name) fullname                   ,afm_no                   ,cust_type                 FROM   customer                    LEFT JOIN other_afm                       ON (    cust_id = other_afm.fk_customercust_id                           AND main_flag = '1'))        ,dir         AS (    SELECT loans_benefs_vw.cust_id                   ,type_id                   ,account_number agreement_number                   ,LISTAGG (NVL (TRIM (related_cust_id), ' '), ',')                       WITHIN GROUP (ORDER BY fullname)                       directors_ids                   ,LISTAGG (NVL (TRIM (related_full_name), ' '), ',')                       WITHIN GROUP (ORDER BY fullname)                       directors_names                   ,LISTAGG (NVL (TRIM (related_afm_no), ' '), ',')                       WITHIN GROUP (ORDER BY fullname)                       directors_pin_nos                 FROM   loans_benefs_vw                    INNER JOIN cust_relationship_vw                      ON (loans_benefs_vw.cust_id = cust_relationship_vw.cust_id )                    INNER JOIN cust                      ON (cust.cust_id = CUST_RELATIONSHIP_VW.CUST_ID )                 WHERE  cust.cust_type = '2' AND type_id = 'DIRECTOR'             GROUP BY loans_benefs_vw.cust_id, account_number, type_id)        SELECT eom_date          ,eom_loans.account_number          ,eom_loans.agreement_number          ,ben.cust_id          ,fullname borrower_names          ,NVL (afm_no, ' ') borrower_pin_nos          ,NVL (directors_ids, ' ') directors_ids          ,NVL (directors_names, ' ') directors_names          ,NVL (directors_pin_nos, ' ') directors_pin_nos          ,eom_loans.acct_key          ,agr.account_ser_num agree_acct_key        FROM   eom_loans           LEFT JOIN loans_benefs_vw ben              ON (    ben.account_number = eom_loans.agreement_number                  AND eom_loans.agreement_system = 19)           LEFT JOIN cust ON (ben.cust_id = cust.cust_id)           LEFT JOIN dir              ON (    dir.cust_id = eom_loans.cust_id                  AND eom_loans.agreement_number = dir.agreement_number)           LEFT JOIN profits_account agr              ON (    agr.account_number = ben.account_number                  AND agr.prft_system = 19)  WITH NO ROW MOVEMENT;

