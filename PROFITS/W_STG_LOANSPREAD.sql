CREATE VIEW w_stg_loanspread  AS     SELECT pa.account_number           ,s.fk_loan_accountfk acc_unit           ,s.fk0loan_accountacc acc_type           ,s.fk_loan_accountacc acc_sn           ,MAX (s.db_inter_rate_spr + s.cr_inter_rate_spr) spread     FROM   loan_int_spread s            JOIN profits_account pa               ON     s.fk_loan_accountfk = pa.lns_open_unit                  AND s.fk0loan_accountacc = pa.lns_type                  AND s.fk_loan_accountacc = pa.lns_sn                  AND pa.prft_system = 4     WHERE  (s.fk_loan_accountfk            ,s.fk_loan_accountacc            ,s.fk0loan_accountacc            ,s.effective_date) IN (SELECT s.fk_loan_accountfk                                         ,s.fk_loan_accountacc                                         ,s.fk0loan_accountacc                                         ,MAX (effective_date)                                   FROM   loan_int_spread s, bank_parameters bp                                   WHERE  s.effective_date <= bp.curr_trx_date                                   GROUP BY s.fk_loan_accountfk, s.fk_loan_accountacc, s.fk0loan_accountacc)     GROUP BY pa.account_number             ,s.fk_loan_accountfk             ,s.fk0loan_accountacc             ,s.fk_loan_accountacc;

