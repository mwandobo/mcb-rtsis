CREATE VIEW w_stg_loan_ledger_fee  AS     SELECT pa.account_number           ,pa.account_ser_num           ,l.fk_unitcode           ,l.acc_type           ,l.acc_sn           ,  ( ROUND (NVL (sc.commission, 0) * fr.reverse_rate, 2)            +   ROUND (                     NVL (ts.percentage * sc.commission / 100, 0)                   * fr.reverse_rate                  ,2))              * l.install_freq               ledger_fee     FROM   bank_parameters bp            INNER JOIN loan_account l ON (1 = 1)            LEFT JOIN profits_account pa               ON     pa.prft_system = 4                  AND pa.lns_open_unit = l.fk_unitcode                  AND pa.lns_sn = l.acc_sn                  AND pa.lns_type = l.acc_type            JOIN com_scale sc ON sc.fk_currencyid_curr = l.fkcur_is_charged            JOIN tax_scale ts ON ts.fk_currencyid_curr = l.fkcur_is_charged            JOIN loan_trxjust lt               ON     ts.fk_taxid_tax = lt.fk_lns_tax                  AND l.fk_loanfk_producti = lt.fk_loanfk_producti                  AND sc.fk_commissionid_co = lt.fk_lns_commission                  AND lt.fk_prft_transacid =                         CASE                            WHEN l.acc_mechanism = 4 THEN 74131                            ELSE 74141                         END                  AND lt.fk_justificid_just =                         CASE                            WHEN l.acc_mechanism = 4 THEN 74131                            ELSE 74141                         END            LEFT JOIN w_eom_fixing_rate fr               ON (    fr.eom_date = bp.scheduled_date                   AND fr.currency_id = l.fkcur_is_moved_in)     WHERE      sc.validity_date =                   (SELECT MAX (cmax.validity_date)                    FROM   com_scale cmax                    WHERE      cmax.fk_currencyid_curr = sc.fk_currencyid_curr                           AND cmax.fk_commissionid_co = sc.fk_commissionid_co                           AND cmax.scale_id = 1)            AND sc.scale_id = 1            AND ts.scale_id = 1            AND ts.validity_date =                   (SELECT MAX (tmax.validity_date)                    FROM   tax_scale tmax                    WHERE      tmax.fk_currencyid_curr = ts.fk_currencyid_curr                           AND tmax.fk_taxid_tax = ts.fk_taxid_tax                           AND tmax.scale_id = 1);

