CREATE VIEW W_FACT_LOAN_AUTOPAY_TRX  AS  WITH ltrx         AS (    SELECT trx_date                   ,trx_unit                   ,trx_usr                   ,trx_sn                   ,MAX (i_tun_date) i_tun_date                   ,MAX (i_tun_trn_sn) i_tun_trn_sn                   ,MAX (i_tun_usr) i_tun_usr                   ,MAX (i_tun_unit) i_tun_unit                   ,MAX (acc_sn) acc_sn                   ,MAX (acc_type) acc_type                   ,MAX (acc_unit) acc_unit                   ,MAX (ut1_id_currency) ut1_id_currency                   ,MAX (i_justification) i_justification                   ,MAX (i_account_currency) i_account_currency                   ,MAX (channel_id) channel_id                   ,MAX (product_id) product_id                 FROM   loan_trx_recording                 WHERE  trx_internal_sn = 1             GROUP BY trx_date                     ,trx_unit                     ,trx_usr                     ,trx_sn)        ,posted         AS (    SELECT a.trx_usr                   ,a.trx_unit                   ,a.trx_date                   ,a.trx_sn                   ,a.nrm_grp_subscript tun_internal_sn                   ,a.tmpstamp                   ,ltrx.channel_id                   ,DECODE (reversed_flg, '1', 'Reversed', 'Posted')                       transaction_status_flag                   ,'Original' reversal_flag                   ,ltrx.product_id                   ,4981 trx_code                   ,ltrx.i_justification                   ,a.ut_id_currency currency_id                   ,a.reversed_flg                   ,a.ut_cash_db_amn                   ,a.ut_cash_cr_amn                   ,a.ut_journal_db_amn                   ,a.ut_journal_cr_amn                   ,ltrx.acc_sn                   ,ltrx.acc_type                   ,ltrx.acc_unit                   ,a.transaction_amn loan_transaction_amount                 FROM   lns_autopay_acc a                    LEFT JOIN ltrx                       ON     ltrx.trx_date = a.trx_date                          AND ltrx.trx_sn = a.trx_sn                          AND ltrx.trx_usr = a.trx_usr                          AND ltrx.trx_unit = a.trx_unit                          AND ltrx.acc_sn = a.acc_sn                          AND ltrx.acc_type = a.acc_type                          AND ltrx.acc_unit = a.acc_unit)        ,reversal         AS (    SELECT ltrx.trx_usr                   ,ltrx.trx_unit                   ,ltrx.trx_date                   ,a.trx_sn                   ,a.reverse_trx_sn                   ,a.nrm_grp_subscript tun_internal_sn                   ,a.tmpstamp                   ,ltrx.channel_id                   ,ltrx.product_id                   ,4341 trx_code                   ,ltrx.i_justification                   ,ltrx.i_account_currency currency_id                   ,a.reversed_flg                   ,a.ut_cash_db_amn                   ,a.ut_cash_cr_amn                   ,a.ut_journal_db_amn                   ,a.ut_journal_cr_amn                   ,ltrx.acc_sn                   ,ltrx.acc_type                   ,ltrx.acc_unit                   ,a.ut_id_currency                   ,a.nrm_trx_usr_sn                   ,transaction_amn loan_transaction_amount                 FROM   lns_autopay_acc a                    LEFT JOIN ltrx                       ON (    ltrx.i_tun_date = a.trx_date                           AND ltrx.i_tun_trn_sn = a.trx_sn                           AND ltrx.i_tun_usr = a.trx_usr                           AND ltrx.i_tun_unit = a.trx_unit                           AND ltrx.acc_sn = a.acc_sn                           AND ltrx.acc_type = a.acc_type                           AND ltrx.acc_unit = a.acc_unit)                 WHERE  reversed_flg = '1')        ,final         AS (    SELECT posted.trx_usr                   ,posted.trx_unit                   ,posted.trx_date                   ,posted.trx_sn                   ,tun_internal_sn                   ,posted.tmpstamp                   ,posted.channel_id                   ,DECODE (reversed_flg, '1', 'Reversed', 'Posted')                       transaction_status_flag                   ,'Original' reversal_flag                   ,posted.product_id                   ,4981 trx_code                   ,posted.i_justification justification_code                   ,posted.currency_id                   ,posted.reversed_flg                   ,posted.ut_cash_db_amn                   ,posted.ut_cash_cr_amn                   ,posted.ut_journal_db_amn                   ,posted.ut_journal_cr_amn                   ,posted.acc_sn                   ,posted.acc_type                   ,posted.acc_unit                   ,posted.loan_transaction_amount                 FROM   posted                 UNION ALL                 SELECT trx_usr                   ,trx_unit                   ,trx_date                   ,reverse_trx_sn trx_sn                   ,tun_internal_sn                   ,tmpstamp                   ,channel_id                   ,'Posted' transaction_status_flag                   ,'Reversal' reversal_flag                   ,product_id                   ,trx_code                   ,i_justification                   ,currency_id                   ,' ' reversed_flg                   ,-1 * ut_cash_db_amn                   ,-1 * ut_cash_cr_amn                   ,-1 * ut_journal_db_amn                   ,-1 * ut_journal_cr_amn                   ,acc_sn                   ,acc_type                   ,acc_unit                   ,loan_transaction_amount                 FROM   reversal)        SELECT final.trx_usr trx_user          ,final.trx_unit          ,final.trx_date          ,final.trx_sn          ,final.tun_internal_sn          ,final.tmpstamp tmstamp          ,final.channel_id          ,final.product_id product_code          ,final.trx_code          ,justification_code          ,transaction_status_flag          ,reversal_flag          ,currency_id          ,currency.short_descr currency          ,final.ut_cash_db_amn cash_debit_amt          ,final.ut_cash_cr_amn cash_credit_amt          ,final.ut_journal_db_amn journal_debit_amt          ,final.ut_journal_cr_amn journal_credit_amt          ,la.account_ser_num acct_key          ,TRIM (la.account_number) || '-' || TRIM (la.account_cd) account_no          ,justific.description justification_name          ,tr.description transaction_name          ,' ' reversed_tun          ,final.acc_unit account_unit_code          ,loan_transaction_amount          ,agr.fk_bankemployeeid AS agree_officer_id          ,agr.fk0bankemployeeid AS agree_delay_officer_id          ,TRIM (p.account_number) || '-' || TRIM (p.account_cd)              deposit_account_no          ,i_account_number deposit_acc_number          ,p.account_ser_num deposit_acct_key          ,d.cust_id1 deposit_customer_id          ,c.name_standard deposit_customer_name          ,d.i_amount deposits_amount          ,d.acc_id_currency deposits_acct_currency_id          ,d.deposit_type          ,d.id_product deposit_product_id          ,pr.description deposit_product_description          ,d.trx_code deposits_transaction_code          ,tr2.description deposits_transaction_name          ,d.acc_id_currency deposit_currency_id          ,cur.short_descr deposit_currency_code        FROM   final           LEFT JOIN profits_account la              ON (    la.lns_sn = final.acc_sn                  AND la.lns_type = final.acc_type                  AND la.lns_open_unit = final.acc_unit                  AND la.prft_system = 4)           LEFT JOIN currency ON currency.id_currency = final.currency_id           LEFT JOIN justific              ON justific.id_justific = final.justification_code           LEFT JOIN prft_transaction tr ON tr.id_transact = trx_code           LEFT JOIN agreement agr              ON     agr.fk_unitcode = la.agr_unit                 AND agr.agr_sn = la.agr_sn                 AND agr.agr_membership_sn = la.agr_membership_sn                 AND agr.agr_year = la.agr_year           LEFT JOIN dep_trx_recording d              ON (    final.trx_usr = d.trx_usr                  AND final.trx_date = d.trx_date                  AND final.trx_unit = d.trx_unit                  AND d.tun_internal_sn = 1                  AND d.cust_id1 > 0                  AND final.trx_sn = d.trx_usr_sn + 1                  AND d.deposit_type <> 5)           LEFT JOIN profits_account p              ON d.i_account_number = p.dep_acc_number AND p.prft_system = 3           LEFT JOIN w_stg_customer c ON d.cust_id1 = c.cust_id           LEFT JOIN currency cur ON d.acc_id_currency = cur.id_currency           LEFT JOIN prft_transaction tr2 ON tr2.id_transact = d.trx_code           LEFT JOIN product pr ON pr.id_product = d.id_product  WITH NO ROW MOVEMENT;

