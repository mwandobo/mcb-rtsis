CREATE VIEW W_FACT_CP_TRX  AS  WITH t         AS (    SELECT cp_trx_recording.trx_usr                   ,cp_trx_recording.trx_unit                   ,cp_trx_recording.trx_date                   ,cp_trx_recording.trx_sn                   ,cp_trx_recording.tun_internal_sn                   ,'Source' source_target_ind                   ,tmstamp                   ,cp_trx_recording.channel_id                   ,product_code                   ,cp_trx_recording.trx_code                   ,cr_service_justif justification_code                   ,cp_trx_recording.transaction_status                   ,source_currency currency_id                   ,source_dep_account dep_acc_number                   ,CASE                       WHEN cp_trx_recording.source_trn_type IN ('1', '7')                       THEN                          source_u_user_tota                        END                       cash_debit_amt                   ,CASE                       WHEN cp_trx_recording.source_trn_type IN ('2', '8')                       THEN                          source_u_user_tota                        END                       cash_credit_amt                   ,CASE                       WHEN cp_trx_recording.source_trn_type IN ('3')                       THEN                          source_u_user_tota                        END                       journal_debit_amt                   ,CASE                       WHEN cp_trx_recording.source_trn_type IN ('4')                       THEN                          source_u_user_tota                        END                       journal_credit_amt                   ,entry_comments                   ,i_trx_date                   ,i_trx_sn                   ,i_trx_unit                   ,i_trx_usr                   ,trx_recording.acc_amount_5 commission_amt                 FROM   cp_trx_recording                    LEFT JOIN trx_recording                       ON (    cp_trx_recording.trx_unit =                                  trx_recording.trx_unit                           AND cp_trx_recording.trx_date =                                  trx_recording.trx_date                           AND cp_trx_recording.trx_usr =                                  trx_recording.trx_usr                           AND cp_trx_recording.trx_sn = trx_recording.trx_sn                           AND cp_trx_recording.tun_internal_sn =                                  trx_recording.tun_internal_sn                           AND trx_recording.acc_amount_5 <> 0)                 UNION ALL                 SELECT trx_usr                   ,trx_unit                   ,trx_date                   ,trx_sn                   ,tun_internal_sn                   ,'Target' source_target_ind                   ,tmstamp                   ,channel_id                   ,product_code                   ,trx_code                   ,dr_service_justif justification_code                   ,transaction_status                   ,target_currency currency_id                   ,target_dep_account                   ,CASE                       WHEN target_trn_type IN ('1', '7')                       THEN                          target_u_user_tota                        END                       cash_debit_amt                   ,CASE                       WHEN target_trn_type IN ('2', '8')                       THEN                          target_u_user_tota                        END                       cash_credit_amt                   ,CASE                       WHEN target_trn_type IN ('3') THEN target_u_user_tota                        END                       journal_debit_amt                   ,CASE                       WHEN target_trn_type IN ('4') THEN target_u_user_tota                        END                       journal_credit_amt                   ,entry_comments                   ,i_trx_date                   ,i_trx_sn                   ,i_trx_unit                   ,i_trx_usr                   ,NULL commission_amt                 FROM   cp_trx_recording)        SELECT trx_usr trx_user          ,trx_unit          ,trx_date          ,trx_sn          ,tun_internal_sn          ,t.tmstamp          ,channel_id product_code          ,source_target_ind          ,trx_code          ,justification_code          ,DECODE (transaction_status, '1', 'Reversed', 'Posted')              transaction_status_flag          ,currency_id          ,currency.short_descr currency          ,cash_debit_amt          ,cash_credit_amt          ,journal_debit_amt          ,journal_credit_amt          ,t.dep_acc_number          ,acc.account_ser_num acct_key          ,TRIM(acc.account_number) || '-' || acc.account_cd account_no          ,entry_comments comments          ,DECODE (              NVL (i_trx_unit, 0)             ,0, ' '             ,   TO_CHAR (i_trx_date, 'yyyy-mm-dd')              || '|'              || i_trx_sn              || '|'              || i_trx_unit              || '|'              || i_trx_usr)              reversed_tun          ,commission_amt        FROM   t           LEFT JOIN currency ON currency.id_currency = t.currency_id           LEFT JOIN profits_account acc ON (acc.dep_acc_number = t.dep_acc_number )           LEFT JOIN prft_transaction  ON prft_transaction.id_transact = trx_code           LEFT JOIN justific ON justific.id_justific = justification_code  WITH NO ROW MOVEMENT;

